<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ultimate Timer (Real-Time Sync)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .time-up-flash {
            animation: flash 0.5s 3;
        }

        @keyframes flash {

            0%,
            100% {
                background-color: #dc2626;
            }

            50% {
                background-color: inherit;
            }
        }
    </style>
</head>

<body
    class="bg-gray-900 text-white flex flex-col items-center justify-center h-full p-4 overflow-hidden transition-colors duration-500">

    <div id="app-container" class="w-full max-w-md mx-auto">

        <!-- Session Management UI -->
        <div id="session-ui" class="bg-gray-800 rounded-2xl shadow-2xl p-6 space-y-4">
            <h2 class="text-2xl font-bold text-center text-cyan-400">Sync Timer</h2>
            <p class="text-center text-gray-300 text-sm">Create a session to start, or join an existing one to sync.</p>
            <div>
                <button id="create-session"
                    class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg text-xl">Create
                    New Session</button>
            </div>
            <div class="flex items-center gap-2">
                <hr class="w-full border-gray-600"><span class="text-gray-400">OR</span>
                <hr class="w-full border-gray-600">
            </div>
            <div class="flex items-center gap-3">
                <input type="text" id="session-id-input" placeholder="Enter Session ID"
                    class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg px-4 py-2 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="join-session"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-5 py-2 rounded-lg transition-colors duration-200">Join</button>
            </div>
            <p id="session-error" class="text-red-500 text-center text-sm h-4"></p>
        </div>

        <!-- Timer UI (Initially Hidden) -->
        <div id="timer-ui" class="bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 space-y-6 hidden">

            <div class="text-center border-b border-gray-700 pb-4">
                <p class="text-gray-400 text-sm">Session ID:</p>
                <div class="flex items-center justify-center gap-2">
                    <p id="session-id-display" class="text-cyan-400 font-mono text-lg"></p>
                    <button id="copy-session-id" title="Copy ID">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-clipboard" viewBox="0 0 16 16">
                            <path
                                d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                            <path
                                d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="text-center">
                <h1 id="display"
                    class="text-5xl sm:text-6xl font-bold font-mono tracking-tighter text-cyan-400 whitespace-nowrap">
                    00:00:00</h1>
                <p id="direction-label" class="mt-2 text-sm font-medium uppercase tracking-wider text-gray-400">Not
                    Started</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button id="start-pause"
                    class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg text-xl">Start</button>
                <button id="lap-reset"
                    class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg text-xl">Lap</button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button id="reverse"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200">Reverse</button>
                <button id="reset-all"
                    class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200">Reset
                    & Leave</button>
            </div>

            <div class="flex items-center gap-3 pt-4 border-t border-gray-700">
                <input type="text" id="time-input" placeholder="Set time (e.g., 1:30:00)"
                    class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg px-4 py-2 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-cyan-500">
                <button id="set-time"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-5 py-2 rounded-lg">Set</button>
            </div>

            <div id="laps-container" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENT REFERENCES ---
        const sessionUI = document.getElementById('session-ui');
        const timerUI = document.getElementById('timer-ui');
        const createSessionBtn = document.getElementById('create-session');
        const joinSessionBtn = document.getElementById('join-session');
        const sessionIdInput = document.getElementById('session-id-input');
        const sessionIdDisplay = document.getElementById('session-id-display');
        const copySessionIdBtn = document.getElementById('copy-session-id');
        const sessionError = document.getElementById('session-error');

        const display = document.getElementById('display');
        const directionLabel = document.getElementById('direction-label');
        const startPauseBtn = document.getElementById('start-pause');
        const lapResetBtn = document.getElementById('lap-reset');
        const reverseBtn = document.getElementById('reverse');
        const resetAllBtn = document.getElementById('reset-all');
        const timeInput = document.getElementById('time-input');
        const setTimeBtn = document.getElementById('set-time');
        const lapsContainer = document.getElementById('laps-container');

        // --- FIREBASE & SESSION STATE ---
        let db, auth;
        let currentSessionId = null;
        let unsubscribeFromSession = null;

        // --- LOCAL TIMER STATE ---
        let localState = {
            time: 0,
            initialTime: 0,
            direction: 1,
            running: false,
            laps: [],
            lastUpdatedTimestamp: null
        };
        let animationFrameId = null;
        let lastTickTimestamp = null;

        // --- FIREBASE INITIALIZATION ---
        async function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyAqzofYQQKO8IOzOuZxHhT8cerf4JcH5TU",
                authDomain: "thefinalcountdown-b6dfc.firebaseapp.com",
                projectId: "thefinalcountdown-b6dfc",
                storageBucket: "thefinalcountdown-b6dfc.firebasestorage.app",
                messagingSenderId: "694566387672",
                appId: "1:694566387672:web:7aa5b12bcf21c8117f3cad"

            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                return true; // Indicate success
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                sessionError.textContent = "Invalid Firebase config. Please setup your project.";
                return false; // Indicate failure
            }
        }

        // --- SESSION MANAGEMENT ---
        async function createSession() {
            const newSessionId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const initialState = { ...localState, lastUpdatedTimestamp: Date.now() };
            await updateFirestoreState(newSessionId, initialState);
            joinSession(newSessionId);
        }

        async function joinSession(sessionId) {
            if (!sessionId || !db) return;
            sessionError.textContent = '';

            const sessionRef = doc(db, "timers", sessionId);
            const docSnap = await getDoc(sessionRef);

            if (!docSnap.exists()) {
                sessionError.textContent = "Session not found.";
                // NEW: If remembered session is invalid, forget it
                localStorage.removeItem('ultimateTimerLastSessionId');
                return;
            }

            currentSessionId = sessionId;
            // NEW: Remember the session ID on this device
            localStorage.setItem('ultimateTimerLastSessionId', currentSessionId);

            sessionIdDisplay.textContent = currentSessionId;
            sessionUI.classList.add('hidden');
            timerUI.classList.remove('hidden');

            listenToSessionChanges(sessionId);
        }

        function leaveSession() {
            if (unsubscribeFromSession) {
                unsubscribeFromSession();
                unsubscribeFromSession = null;
            }
            // NEW: Forget the session when leaving
            localStorage.removeItem('ultimateTimerLastSessionId');

            currentSessionId = null;
            pause();
            localState = { time: 0, initialTime: 0, direction: 1, running: false, laps: [], lastUpdatedTimestamp: null };
            updateFullUI();
            sessionUI.classList.remove('hidden');
            timerUI.classList.add('hidden');
        }

        async function resetSession() {
            if (currentSessionId) {
                await deleteDoc(doc(db, "timers", currentSessionId));
            }
            leaveSession();
        }

        // --- FIRESTORE REAL-TIME SYNC ---
        function listenToSessionChanges(sessionId) {
            if (unsubscribeFromSession) unsubscribeFromSession();

            const sessionRef = doc(db, "timers", sessionId);
            unsubscribeFromSession = onSnapshot(sessionRef, (docSnap) => {
                if (!docSnap.exists()) {
                    alert("Session was deleted.");
                    leaveSession();
                    return;
                }

                const serverState = docSnap.data();

                if (serverState.running && serverState.lastUpdatedTimestamp) {
                    const timeElapsed = (Date.now() - serverState.lastUpdatedTimestamp) / 1000;
                    serverState.time += serverState.direction * timeElapsed;
                }

                localState = serverState;
                updateFullUI();

                if (localState.running) {
                    startLocalTicker();
                } else {
                    stopLocalTicker();
                }
            });
        }

        async function updateFirestoreState(sessionId, state) {
            if (!sessionId || !db) return;
            const sessionRef = doc(db, "timers", sessionId);
            await setDoc(sessionRef, state);
        }

        // --- CORE TIMER LOGIC ---
        function localTick(timestamp) {
            if (lastTickTimestamp) {
                const delta = (timestamp - lastTickTimestamp) / 1000;
                localState.time += localState.direction * delta;
                updateDisplay();
            }
            lastTickTimestamp = timestamp;
            animationFrameId = requestAnimationFrame(localTick);
        }

        function startLocalTicker() {
            if (animationFrameId) return;
            lastTickTimestamp = null;
            animationFrameId = requestAnimationFrame(localTick);
        }

        function stopLocalTicker() {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }

        // --- UI & DISPLAY ---
        function formatTime(totalSeconds) {
            if (typeof totalSeconds !== 'number') totalSeconds = 0;
            const isNegative = totalSeconds < 0;
            if (isNegative) totalSeconds = Math.abs(totalSeconds);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${isNegative ? '-' : ''}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateDisplay() {
            display.textContent = formatTime(localState.time);
        }

        function updateFullUI() {
            updateDisplay();
            directionLabel.textContent = localState.running ? (localState.direction === 1 ? 'Counting Up' : 'Counting Down') : 'Paused';

            lapsContainer.innerHTML = '';
            (localState.laps || []).forEach(lap => addLapToDOM(lap.text, lap.time));

            if (localState.running) {
                startPauseBtn.textContent = 'Pause';
                startPauseBtn.className = 'w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg text-xl';
                lapResetBtn.textContent = 'Lap';
            } else {
                startPauseBtn.textContent = 'Start';
                startPauseBtn.className = 'w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg text-xl';
                lapResetBtn.textContent = 'Reset';
            }
        }

        function addLapToDOM(lapText, lapTime) {
            const lapElement = document.createElement('div');
            lapElement.className = 'flex justify-between items-center bg-gray-700/50 p-2 rounded-md text-sm';
            lapElement.innerHTML = `<span class="font-medium text-gray-300">${lapText}</span><span class="font-mono font-semibold">${lapTime}</span>`;
            lapsContainer.prepend(lapElement);
        }

        // --- CONTROL FUNCTIONS (OPTIMISTIC UI) ---
        function handleStartPause() {
            localState.running = !localState.running;
            localState.lastUpdatedTimestamp = Date.now();
            updateFullUI();
            if (localState.running) {
                startLocalTicker();
            } else {
                stopLocalTicker();
            }
            updateFirestoreState(currentSessionId, localState);
        }

        function handleSetTime() {
            const inputVal = timeInput.value.trim();
            if (inputVal === "") return;
            let seconds = 0;
            if (inputVal.includes(':')) {
                const parts = inputVal.split(':').map(Number).reverse();
                seconds = (parts[0] || 0) + (parts[1] || 0) * 60 + (parts[2] || 0) * 3600;
            } else {
                seconds = parseFloat(inputVal) || 0;
            }
            localState.time = seconds;
            localState.initialTime = seconds;
            localState.running = false;
            localState.lastUpdatedTimestamp = Date.now();
            updateFullUI();
            stopLocalTicker();
            updateFirestoreState(currentSessionId, localState);
        }

        function handleLapReset() {
            if (localState.running) {
                const newLaps = [...(localState.laps || []), { text: `Lap ${(localState.laps || []).length + 1}`, time: formatTime(localState.time) }];
                localState.laps = newLaps;
            } else {
                localState.time = localState.initialTime;
                localState.laps = [];
            }
            localState.lastUpdatedTimestamp = Date.now();
            updateFullUI();
            updateFirestoreState(currentSessionId, localState);
        }

        function handleReverse() {
            localState.direction *= -1;
            localState.lastUpdatedTimestamp = Date.now();
            updateFullUI();
            updateFirestoreState(currentSessionId, localState);
        }

        // --- EVENT LISTENERS ---
        createSessionBtn.addEventListener('click', createSession);
        joinSessionBtn.addEventListener('click', () => joinSession(sessionIdInput.value.trim().toUpperCase()));
        sessionIdInput.addEventListener('keydown', (e) => e.key === 'Enter' && joinSession(sessionIdInput.value.trim().toUpperCase()));
        copySessionIdBtn.addEventListener('click', () => navigator.clipboard.writeText(currentSessionId).then(() => alert('Session ID copied!')));

        startPauseBtn.addEventListener('click', handleStartPause);
        lapResetBtn.addEventListener('click', handleLapReset);
        reverseBtn.addEventListener('click', handleReverse);
        resetAllBtn.addEventListener('click', resetSession);
        setTimeBtn.addEventListener('click', handleSetTime);
        timeInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleSetTime());

        // --- INITIALIZATION ---
        async function main() {
            const firebaseReady = await initFirebase();
            if (firebaseReady) {
                // NEW: Check for a remembered session ID in localStorage
                const rememberedSessionId = localStorage.getItem('ultimateTimerLastSessionId');
                if (rememberedSessionId) {
                    joinSession(rememberedSessionId);
                }
            }
        }

        main();

    </script>
</body>

</html>