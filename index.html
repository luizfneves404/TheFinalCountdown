<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Final Countdown</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom class for the time-up flash effect */
        @keyframes flash {
            0%, 100% { background-color: #dc2626; } /* red-600 */
            50% { background-color: inherit; }
        }
        .time-up-flash {
            animation: flash 0.5s 3; /* Flash 3 times */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-full p-4 overflow-hidden">

    <div class="w-full max-w-md mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 space-y-6">
        
        <!-- Time Display -->
        <div class="text-center">
            <!-- Adjusted font size to prevent overflow -->
            <h1 id="display" class="text-5xl sm:text-6xl font-bold font-mono tracking-tighter text-cyan-400 whitespace-nowrap">00:00:00.00</h1>
            <p id="direction-label" class="mt-2 text-sm font-medium uppercase tracking-wider text-gray-400">Counting Up</p>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-2 gap-4">
            <button id="start-pause" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg focus:outline-none focus:ring-4 focus:ring-cyan-500/50 text-xl">
                Start
            </button>
            <button id="lap-reset" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg focus:outline-none focus:ring-4 focus:ring-gray-600/50 text-xl">
                Lap
            </button>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
             <button id="reverse" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-500/50">
                Reverse
            </button>
            <button id="reset-all" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md focus:outline-none focus:ring-4 focus:ring-red-600/50">
                Reset All
            </button>
        </div>

        <!-- Set Time Input -->
        <div class="flex items-center gap-3 pt-4 border-t border-gray-700">
            <!-- Updated placeholder text -->
            <input type="text" id="time-input" placeholder="Set time (e.g., 1:30:00 or 5:30)" class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg px-4 py-2 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
            <button id="set-time" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-5 py-2 rounded-lg transition-colors duration-200">Set</button>
        </div>
        
        <!-- Laps List -->
        <div id="laps-container" class="space-y-2 max-h-48 overflow-y-auto pr-2">
            <!-- Lap times will be inserted here -->
        </div>

    </div>

    <script>
        // --- DOM ELEMENT REFERENCES ---
        const display = document.getElementById('display');
        const directionLabel = document.getElementById('direction-label');
        const startPauseBtn = document.getElementById('start-pause');
        const lapResetBtn = document.getElementById('lap-reset');
        const reverseBtn = document.getElementById('reverse');
        const resetAllBtn = document.getElementById('reset-all');
        const timeInput = document.getElementById('time-input');
        const setTimeBtn = document.getElementById('set-time');
        const lapsContainer = document.getElementById('laps-container');
        const body = document.body;

        // --- TIMER STATE ---
        let time = 0;
        let initialTime = 0;
        let direction = 1;
        let running = false;
        let lastTimestamp = null;
        let animationFrameId = null;
        let laps = []; // Store laps in an array

        // --- LOCALSTORAGE PERSISTENCE ---

        function saveState() {
            const state = {
                time: time,
                initialTime: initialTime,
                direction: direction,
                running: running,
                laps: laps,
                savedTimestamp: running ? Date.now() : null 
            };
            localStorage.setItem('ultimateTimerState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('ultimateTimerState');
            if (!savedState) return;

            const state = JSON.parse(savedState);
            
            time = state.time || 0;
            initialTime = state.initialTime || 0;
            direction = state.direction || 1;
            laps = state.laps || [];

            if (state.running && state.savedTimestamp) {
                const timeElapsed = (Date.now() - state.savedTimestamp) / 1000;
                time += direction * timeElapsed;
            }

            lapsContainer.innerHTML = '';
            laps.forEach(lap => addLapToDOM(lap.text, lap.time));
            
            updateFullUI();

            if (state.running) {
                start();
            }
        }


        // --- CORE TIMER LOGIC ---

        function tick(timestamp) {
            if (running) {
                if (lastTimestamp != null) {
                    const delta = (timestamp - lastTimestamp) / 1000;
                    time += direction * delta;
                }
                lastTimestamp = timestamp;
                updateDisplay();

                if (direction === -1 && time <= 0) {
                    time = 0;
                    pause();
                    updateDisplay();
                    body.classList.add('time-up-flash');
                    setTimeout(() => body.classList.remove('time-up-flash'), 1500);
                }
                
                animationFrameId = requestAnimationFrame(tick);
            }
        }

        // --- DISPLAY FORMATTING & UI UPDATES ---

        /**
         * UPDATED: Formats seconds into a HH:MM:SS.ss string.
         */
        function formatTime(totalSeconds) {
            const isNegative = totalSeconds < 0;
            if (isNegative) totalSeconds = Math.abs(totalSeconds);

            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const milliseconds = Math.floor((totalSeconds * 100) % 100);

            const sign = isNegative ? "-" : "";
            
            return `${sign}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
        }

        function updateDisplay() {
            display.innerText = formatTime(time);
        }

        function updateFullUI() {
            updateDisplay();
            directionLabel.innerText = direction === 1 ? 'Counting Up' : 'Counting Down';
            
            if (running) {
                startPauseBtn.innerText = 'Pause';
                startPauseBtn.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');
                startPauseBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-500');
                lapResetBtn.innerText = 'Lap';
            } else {
                startPauseBtn.innerText = 'Start';
                startPauseBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500');
                startPauseBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-500');
                lapResetBtn.innerText = 'Reset';
            }
        }

        // --- CONTROL FUNCTIONS ---

        function start() {
            if (!running) {
                running = true;
                lastTimestamp = null;
                animationFrameId = requestAnimationFrame(tick);
                updateFullUI();
            }
        }

        function pause() {
            if (running) {
                running = false;
                cancelAnimationFrame(animationFrameId);
                updateFullUI();
                saveState();
            }
        }

        function reverse() {
            direction *= -1;
            updateFullUI();
            saveState();
        }

        function resetCurrent() {
            pause();
            time = initialTime;
            updateFullUI();
            saveState();
        }

        function resetAll() {
            pause();
            time = 0;
            initialTime = 0;
            laps = [];
            lapsContainer.innerHTML = '';
            timeInput.value = '';
            updateFullUI();
            localStorage.removeItem('ultimateTimerState');
        }
        
        function addLapToDOM(lapText, lapTime) {
             const lapElement = document.createElement('div');
            lapElement.className = 'flex justify-between items-center bg-gray-700/50 p-2 rounded-md text-sm';
            lapElement.innerHTML = `
                <span class="font-medium text-gray-300">${lapText}</span>
                <span class="font-mono font-semibold">${lapTime}</span>
            `;
            lapsContainer.prepend(lapElement);
        }

        function addLap() {
            if (!running) return;

            const lapTime = formatTime(time);
            const lapText = `Lap ${laps.length + 1}`;
            laps.push({ text: lapText, time: lapTime });
            addLapToDOM(lapText, lapTime);
            saveState();
        }

        /**
         * UPDATED: Parses user input from the text field to set the timer.
         * Supports "HH:MM:SS", "MM:SS" format, and raw seconds.
         */
        function handleSetTime() {
            const inputVal = timeInput.value.trim();
            if (inputVal === "") return;

            let seconds = 0;
            if (inputVal.includes(':')) {
                const parts = inputVal.split(':').map(Number);
                if (parts.length === 3) { // HH:MM:SS
                    seconds = (parts[0] || 0) * 3600 + (parts[1] || 0) * 60 + (parts[2] || 0);
                } else if (parts.length === 2) { // MM:SS
                    seconds = (parts[0] || 0) * 60 + (parts[1] || 0);
                }
            } else {
                seconds = parseFloat(inputVal) || 0;
            }
            
            pause();
            time = seconds;
            initialTime = seconds;
            updateFullUI();
            saveState();
        }

        // --- EVENT LISTENERS ---
        startPauseBtn.addEventListener('click', () => running ? pause() : start());
        lapResetBtn.addEventListener('click', () => running ? addLap() : resetCurrent());
        reverseBtn.addEventListener('click', reverse);
        resetAllBtn.addEventListener('click', resetAll);
        setTimeBtn.addEventListener('click', handleSetTime);
        timeInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleSetTime());
        
        window.addEventListener('beforeunload', () => {
            if (time !== 0 || initialTime !== 0 || laps.length > 0) {
                 saveState();
            }
        });
        
        // --- INITIALIZATION ---
        loadState();
    </script>
</body>
</html>
